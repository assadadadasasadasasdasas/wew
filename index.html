<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IANUS - Åžapka</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    min-height: 100vh;
    background: #0c0c0c;
    color: #eee;
    font-family: Georgia, serif;
  }
  header {
    padding: 20px 24px;
    border-bottom: 1px solid #222;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 {
    font-size: 28px;
    font-weight: 400;
    letter-spacing: 10px;
    color: #d4b896;
  }
  header span { font-size: 12px; color: #666; letter-spacing: 2px; }
  .container { max-width: 540px; margin: 0 auto; padding: 30px 20px; }
  .label { font-size: 12px; color: #888; letter-spacing: 2px; margin-bottom: 12px; }
  .hats { display: flex; gap: 12px; margin-bottom: 30px; }
  .hat-card {
    flex: 1; padding: 16px;
    border: 1px solid #333; background: #111;
    cursor: pointer; text-align: center; border-radius: 6px;
  }
  .hat-card.active { border: 2px solid #d4b896; background: rgba(212,184,150,0.05); }
  .hat-card p { margin-top: 8px; font-size: 14px; }
  .hat-card .price { font-size: 13px; color: #d4b896; margin-top: 4px; }
  .upload-box {
    border: 2px dashed #333; border-radius: 8px;
    padding: 60px 20px; text-align: center;
    cursor: pointer; background: #111;
  }
  .upload-box:hover { border-color: #d4b896; }
  #fileInput { display: none; }
  #canvas {
    width: 100%; border-radius: 8px;
    border: 1px solid #222; cursor: grab;
  }
  #canvas.grabbing { cursor: grabbing; }
  .size-controls {
    display: flex; align-items: center;
    justify-content: center; gap: 16px; margin-top: 16px;
  }
  .size-btn {
    width: 36px; height: 36px; border-radius: 50%;
    background: #1a1a1a; border: 1px solid #333;
    color: #ddd; font-size: 18px; cursor: pointer;
  }
  .size-btn:hover { border-color: #d4b896; }
  .buttons { display: flex; gap: 12px; margin-top: 20px; }
  .btn-primary {
    flex: 1; padding: 14px; background: #d4b896; color: #0c0c0c;
    border: none; border-radius: 6px; font-size: 14px;
    font-weight: 600; cursor: pointer; font-family: Georgia, serif;
  }
  .btn-secondary {
    flex: 1; padding: 14px; background: transparent; color: #aaa;
    border: 1px solid #333; border-radius: 6px;
    font-size: 14px; cursor: pointer; font-family: Georgia, serif;
  }
  .editor { display: none; }
  .editor.show { display: block; }
  .loading {
    text-align: center; padding: 30px; color: #d4b896;
  }
  .spinner {
    display: inline-block; width: 24px; height: 24px;
    border: 2px solid #333; border-top-color: #d4b896;
    border-radius: 50%; animation: spin 0.8s linear infinite;
    margin-bottom: 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .status {
    text-align: center; padding: 8px;
    font-size: 12px; color: #666; letter-spacing: 1px;
    margin-bottom: 16px;
  }
  .status.ready { color: #6a6; }
  .status.error { color: #a66; }
  footer {
    text-align: center; font-size: 11px; color: #444;
    margin-top: 60px; letter-spacing: 2px; padding-bottom: 20px;
  }
</style>
</head>
<body>

<header>
  <h1>IANUS</h1>
  <span>ÅžAPKA</span>
</header>

<div class="container">

  <div class="status" id="modelStatus">YÃ¼z tanÄ±ma modeli yÃ¼kleniyor...</div>

  <p class="label">ÅžAPKA SEÃ‡</p>
  <div class="hats">
    <div class="hat-card active" onclick="selectHat('black')" id="card-black">
      <svg width="70" height="46" viewBox="0 0 120 78">
        <ellipse cx="60" cy="65" rx="55" ry="13" fill="#222"/>
        <path d="M20,62 Q14,25 35,12 Q60,-2 85,12 Q106,25 100,62Z" fill="#1a1a1a"/>
        <rect x="20" y="52" width="80" height="6" rx="1" fill="#444"/>
      </svg>
      <p>Siyah Åžapka</p>
      <p class="price">â‚º890</p>
    </div>
    <div class="hat-card" onclick="selectHat('white')" id="card-white">
      <svg width="70" height="46" viewBox="0 0 120 78">
        <ellipse cx="60" cy="65" rx="55" ry="13" fill="#ddd"/>
        <path d="M20,62 Q14,25 35,12 Q60,-2 85,12 Q106,25 100,62Z" fill="#f0f0f0"/>
        <rect x="20" y="52" width="80" height="6" rx="1" fill="#bbb"/>
      </svg>
      <p>Beyaz Åžapka</p>
      <p class="price">â‚º890</p>
    </div>
  </div>

  <div class="upload-box" id="uploadBox" onclick="document.getElementById('fileInput').click()">
    <p style="font-size:40px;margin-bottom:12px">ðŸ“·</p>
    <p style="font-size:16px;color:#aaa">FotoÄŸrafÄ±nÄ± YÃ¼kle</p>
    <p style="font-size:13px;color:#666;margin-top:8px">AI yÃ¼zÃ¼nÃ¼ bulup ÅŸapkayÄ± otomatik yerleÅŸtirecek</p>
  </div>
  <input type="file" id="fileInput" accept="image/*">

  <div class="loading" id="loadingBox" style="display:none">
    <div class="spinner"></div>
    <p>YÃ¼z algÄ±lanÄ±yor...</p>
  </div>

  <div class="editor" id="editor">
    <p class="label">ÅžAPKAYI SÃœRÃœKLE VE AYARLA</p>
    <canvas id="canvas"></canvas>
    <div class="size-controls">
      <button class="size-btn" onclick="changeSize(-0.1)">âˆ’</button>
      <span style="font-size:12px;color:#888">Boyut</span>
      <button class="size-btn" onclick="changeSize(0.1)">+</button>
    </div>
    <div class="buttons">
      <button class="btn-primary" onclick="downloadImage()">FotoÄŸrafÄ± Ä°ndir</button>
      <button class="btn-secondary" onclick="resetPhoto()">Yeni FotoÄŸraf</button>
    </div>
  </div>

  <footer>Â© 2026 IANUS</footer>
</div>

<!-- MediaPipe kÃ¼tÃ¼phanesi -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.js" crossorigin="anonymous"></script>

<script>
// ========== DEÄžÄ°ÅžKENLER ==========
var currentHat = "black";
var hatScale = 1;
var hatX = 150, hatY = 30;
var dragging = false;
var offX = 0, offY = 0;
var userImage = null;
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
var faceLandmarker = null;
var modelReady = false;

// ========== 1) MODEL YÃœKLE ==========
async function initModel() {
  try {
    var visionLib = window.vision || self.vision;
    var resolver = await visionLib.FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
    );
    faceLandmarker = await visionLib.FaceLandmarker.createFromOptions(resolver, {
      baseOptions: {
        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
        delegate: "GPU"
      },
      runningMode: "IMAGE",
      numFaces: 1
    });
    modelReady = true;
    document.getElementById("modelStatus").textContent = "âœ“ YÃ¼z tanÄ±ma hazÄ±r";
    document.getElementById("modelStatus").className = "status ready";
  } catch (err) {
    console.error("Model hatasÄ±:", err);
    document.getElementById("modelStatus").textContent = "âš  Model yÃ¼klenemedi â€” manuel mod";
    document.getElementById("modelStatus").className = "status error";
  }
}
initModel();

// ========== 2) ÅžAPKA Ã‡Ä°Z ==========
function drawHat() {
  var w = 140 * hatScale;
  var h = 95 * hatScale;
  var dark = currentHat === "black";
  var x = hatX, y = hatY;

  ctx.save();
  ctx.shadowColor = "rgba(0,0,0,0.4)";
  ctx.shadowBlur = 14;
  ctx.shadowOffsetY = 5;

  var brimY = y + h * 0.72;
  ctx.beginPath();
  ctx.ellipse(x + w / 2, brimY, w * 0.65, h * 0.22, 0, 0, Math.PI * 2);
  ctx.fillStyle = dark ? "#222" : "#ddd";
  ctx.fill();

  ctx.beginPath();
  ctx.moveTo(x + w * 0.14, brimY - 2);
  ctx.quadraticCurveTo(x + w * 0.08, y + h * 0.15, x + w * 0.27, y + h * 0.05);
  ctx.quadraticCurveTo(x + w * 0.5, y - h * 0.06, x + w * 0.73, y + h * 0.05);
  ctx.quadraticCurveTo(x + w * 0.92, y + h * 0.15, x + w * 0.86, brimY - 2);
  ctx.closePath();
  ctx.fillStyle = dark ? "#1a1a1a" : "#f0f0f0";
  ctx.fill();

  ctx.fillStyle = dark ? "#444" : "#bbb";
  ctx.fillRect(x + w * 0.14, brimY - h * 0.14, w * 0.72, h * 0.08);
  ctx.restore();
}

function redraw() {
  if (!userImage) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(userImage, 0, 0, canvas.width, canvas.height);
  drawHat();
}

// ========== 3) YÃœZ BUL + ÅžAPKA YERLEÅžTÄ°R ==========
function detectAndPlace(img) {
  if (!faceLandmarker || !modelReady) {
    hatX = canvas.width / 2 - 70;
    hatY = 30;
    hatScale = 1;
    return;
  }

  try {
    var result = faceLandmarker.detect(img);
    if (!result.faceLandmarks || result.faceLandmarks.length === 0) {
      alert("YÃ¼z bulunamadÄ±! YÃ¼zÃ¼nÃ¼zÃ¼n net gÃ¶rÃ¼ndÃ¼ÄŸÃ¼ bir fotoÄŸraf deneyin.");
      hatX = canvas.width / 2 - 70;
      hatY = 30;
      hatScale = 1;
      return;
    }

    var lm = result.faceLandmarks[0];

    // Nokta 10 = alÄ±n tepesi, 152 = Ã§ene, 234 = sol ÅŸakak, 454 = saÄŸ ÅŸakak
    var topX = lm[10].x * canvas.width;
    var topY = lm[10].y * canvas.height;
    var chinY = lm[152].y * canvas.height;
    var faceW = (lm[454].x - lm[234].x) * canvas.width;
    var faceH = chinY - topY;

    // Åžapka boyutu = yÃ¼z geniÅŸliÄŸi Ã— 1.3
    var targetW = faceW * 1.3;
    hatScale = targetW / 140;

    var actualW = 140 * hatScale;
    var actualH = 95 * hatScale;

    // ÅžapkayÄ± alÄ±nÄ±n Ã¼stÃ¼ne koy
    hatX = topX - actualW / 2;
    hatY = topY - actualH * 0.55;

  } catch (err) {
    console.error("AlgÄ±lama hatasÄ±:", err);
    hatX = canvas.width / 2 - 70;
    hatY = 30;
    hatScale = 1;
  }
}

// ========== 4) DOSYA YÃœKLE ==========
function loadFile(file) {
  var reader = new FileReader();
  reader.onload = function (ev) {
    document.getElementById("uploadBox").style.display = "none";
    document.getElementById("loadingBox").style.display = "block";

    var img = new Image();
    img.onload = function () {
      userImage = img;
      var maxW = Math.min(500, window.innerWidth - 40);
      var sc = maxW / img.width;
      canvas.width = maxW;
      canvas.height = img.height * sc;

      detectAndPlace(img);

      document.getElementById("loadingBox").style.display = "none";
      document.getElementById("editor").className = "editor show";
      redraw();
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

document.getElementById("fileInput").addEventListener("change", function (e) {
  if (e.target.files[0]) loadFile(e.target.files[0]);
});

var ub = document.getElementById("uploadBox");
ub.addEventListener("dragover", function (e) { e.preventDefault(); ub.style.borderColor = "#d4b896"; });
ub.addEventListener("dragleave", function () { ub.style.borderColor = "#333"; });
ub.addEventListener("drop", function (e) {
  e.preventDefault(); ub.style.borderColor = "#333";
  if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
});

// ========== 5) SÃœRÃœKLEME ==========
function getPos(e) {
  var r = canvas.getBoundingClientRect();
  var cx = e.touches ? e.touches[0].clientX : e.clientX;
  var cy = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: (cx - r.left) * (canvas.width / r.width), y: (cy - r.top) * (canvas.height / r.height) };
}
function onDown(e) {
  e.preventDefault();
  var p = getPos(e), w = 140 * hatScale, h = 95 * hatScale;
  if (p.x >= hatX && p.x <= hatX + w && p.y >= hatY && p.y <= hatY + h) {
    dragging = true; offX = p.x - hatX; offY = p.y - hatY;
    canvas.className = "grabbing";
  }
}
function onMove(e) {
  if (!dragging) return; e.preventDefault();
  var p = getPos(e); hatX = p.x - offX; hatY = p.y - offY; redraw();
}
function onUp() { dragging = false; canvas.className = ""; }

canvas.addEventListener("mousedown", onDown);
canvas.addEventListener("mousemove", onMove);
canvas.addEventListener("mouseup", onUp);
canvas.addEventListener("mouseleave", onUp);
canvas.addEventListener("touchstart", onDown, { passive: false });
canvas.addEventListener("touchmove", onMove, { passive: false });
canvas.addEventListener("touchend", onUp);

// ========== 6) BUTONLAR ==========
function selectHat(id) {
  currentHat = id;
  document.getElementById("card-black").className = id === "black" ? "hat-card active" : "hat-card";
  document.getElementById("card-white").className = id === "white" ? "hat-card active" : "hat-card";
  if (userImage) redraw();
}
function changeSize(d) {
  hatScale = Math.max(0.3, Math.min(2.5, hatScale + d));
  if (userImage) redraw();
}
function downloadImage() {
  var a = document.createElement("a"); a.download = "ianus-sapka.png";
  a.href = canvas.toDataURL(); a.click();
}
function resetPhoto() {
  userImage = null;
  document.getElementById("uploadBox").style.display = "block";
  document.getElementById("editor").className = "editor";
  document.getElementById("fileInput").value = "";
}
</script>
</body>
</html>
</body>
</html>
